name: CD - Deploy Infrastructure

on:
  workflow_dispatch:
    inputs:
      deployment_number:
        description: 'Deployment number (1-999) - determines resource names'
        required: true
        type: number
      location:
        description: 'Azure region for deployment'
        required: false
        default: 'eastus2'
        type: choice
        options:
          - eastus2
          - eastus
          - westus2
          - westeurope
          - northeurope

  # Allow this workflow to be called from cd-app.yml
  workflow_call:
    inputs:
      deployment_number:
        description: 'Deployment number (1-999)'
        required: true
        type: number
      location:
        description: 'Azure region for deployment'
        required: false
        default: 'eastus2'
        type: string

env:
  AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

jobs:
  deploy-infrastructure:
    name: Deploy Infrastructure
    runs-on: ubuntu-latest
    outputs:
      resource_group: ${{ steps.deploy.outputs.resource_group }}
      function_app_name: ${{ steps.deploy.outputs.function_app_name }}
      static_web_app_name: ${{ steps.deploy.outputs.static_web_app_name }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate deployment number
        run: |
          DEPLOYMENT_NUMBER=${{ inputs.deployment_number }}
          if [ "$DEPLOYMENT_NUMBER" -lt 1 ] || [ "$DEPLOYMENT_NUMBER" -gt 999 ]; then
            echo "âŒ Deployment number must be between 1 and 999"
            exit 1
          fi
          echo "âœ… Deployment number: $DEPLOYMENT_NUMBER"

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Validate Bicep template
        run: |
          echo "ðŸ” Validating Bicep template..."
          az bicep build --file infra/main.bicep --stdout > /dev/null
          echo "âœ… Bicep validation successful"

      - name: Deploy Infrastructure
        id: deploy
        run: |
          DEPLOYMENT_NUMBER=${{ inputs.deployment_number }}
          LOCATION=${{ inputs.location || 'eastus2' }}
          RESOURCE_GROUP="AMAFY26-deployment-${DEPLOYMENT_NUMBER}"
          
          echo "ðŸš€ Deploying infrastructure..."
          echo "   Deployment Number: $DEPLOYMENT_NUMBER"
          echo "   Location: $LOCATION"
          echo "   Resource Group: $RESOURCE_GROUP"
          
          # Deploy at subscription level
          az deployment sub create \
            --name "deployment-${DEPLOYMENT_NUMBER}-$(date +%Y%m%d%H%M%S)" \
            --location "$LOCATION" \
            --template-file infra/main.bicep \
            --parameters deploymentNumber=$DEPLOYMENT_NUMBER location=$LOCATION \
            --verbose
          
          # Set outputs
          echo "resource_group=$RESOURCE_GROUP" >> $GITHUB_OUTPUT
          echo "function_app_name=FuncApp-AMA-${DEPLOYMENT_NUMBER}" >> $GITHUB_OUTPUT
          echo "static_web_app_name=SWA-AMA-${DEPLOYMENT_NUMBER}" >> $GITHUB_OUTPUT
          
          echo "âœ… Infrastructure deployment complete!"

      - name: Deployment Summary
        run: |
          echo "## Infrastructure Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Resource | Name |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| Resource Group | AMAFY26-deployment-${{ inputs.deployment_number }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Function App | FuncApp-AMA-${{ inputs.deployment_number }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Static Web App | SWA-AMA-${{ inputs.deployment_number }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Storage Account | storageama${{ inputs.deployment_number }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Key Vault | KeyVault-AMA-${{ inputs.deployment_number }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Speech Service | Speech-AMA-${{ inputs.deployment_number }} |" >> $GITHUB_STEP_SUMMARY
          echo "| App Insights | AppInsights-AMA-${{ inputs.deployment_number }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Location:** ${{ inputs.location || 'eastus2' }}" >> $GITHUB_STEP_SUMMARY
