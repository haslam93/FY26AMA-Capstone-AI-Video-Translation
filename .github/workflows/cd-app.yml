name: CD - Deploy Application

on:
  workflow_dispatch:
    inputs:
      deployment_number:
        description: 'Deployment number (1-999) - determines target resources'
        required: true
        type: number
      run_infrastructure:
        description: 'Deploy infrastructure first?'
        required: false
        default: false
        type: boolean
      location:
        description: 'Azure region (only used if deploying infrastructure)'
        required: false
        default: 'eastus2'
        type: choice
        options:
          - eastus2
          - eastus
          - westus2
          - westeurope
          - northeurope

env:
  DOTNET_VERSION_API: '8.0.x'
  DOTNET_VERSION_UI: '9.0.x'
  AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

jobs:
  # ============================================================================
  # Optional: Deploy Infrastructure First
  # ============================================================================
  deploy-infrastructure:
    name: Deploy Infrastructure (Optional)
    if: ${{ inputs.run_infrastructure == true }}
    uses: ./.github/workflows/cd-infra.yml
    with:
      deployment_number: ${{ inputs.deployment_number }}
      location: ${{ inputs.location }}
    secrets: inherit

  # ============================================================================
  # Build API
  # ============================================================================
  build-api:
    name: Build API
    runs-on: ubuntu-latest
    needs: [deploy-infrastructure]
    if: always() && (needs.deploy-infrastructure.result == 'success' || needs.deploy-infrastructure.result == 'skipped')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET ${{ env.DOTNET_VERSION_API }}
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION_API }}

      - name: Restore dependencies
        working-directory: src/Api
        run: dotnet restore

      - name: Build and Publish
        working-directory: src/Api
        run: |
          dotnet publish --configuration Release --output ./publish

      - name: Upload API artifact
        uses: actions/upload-artifact@v4
        with:
          name: api-package
          path: src/Api/publish

  # ============================================================================
  # Build UI
  # ============================================================================
  build-ui:
    name: Build UI
    runs-on: ubuntu-latest
    needs: [deploy-infrastructure]
    if: always() && (needs.deploy-infrastructure.result == 'success' || needs.deploy-infrastructure.result == 'skipped')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET ${{ env.DOTNET_VERSION_UI }}
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION_UI }}

      - name: Restore dependencies
        working-directory: src/ui
        run: dotnet restore

      - name: Build and Publish
        working-directory: src/ui
        run: |
          dotnet publish --configuration Release --output ./publish

      - name: Upload UI artifact
        uses: actions/upload-artifact@v4
        with:
          name: ui-package
          path: src/ui/publish/wwwroot

  # ============================================================================
  # Deploy API to Function App
  # ============================================================================
  deploy-api:
    name: Deploy API
    runs-on: ubuntu-latest
    needs: [build-api]
    environment:
      name: production
      url: https://funcapp-ama-${{ inputs.deployment_number }}.azurewebsites.net
    steps:
      - name: Download API artifact
        uses: actions/download-artifact@v4
        with:
          name: api-package
          path: ./api-package

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Deploy to Azure Functions
        run: |
          FUNCTION_APP_NAME="FuncApp-AMA-${{ inputs.deployment_number }}"
          RESOURCE_GROUP="AMAFY26-deployment-${{ inputs.deployment_number }}"
          
          echo "ðŸš€ Deploying API to $FUNCTION_APP_NAME..."
          
          # Create zip package
          cd api-package
          zip -r ../api.zip .
          cd ..
          
          # Deploy using Azure CLI
          az functionapp deployment source config-zip \
            --resource-group "$RESOURCE_GROUP" \
            --name "$FUNCTION_APP_NAME" \
            --src api.zip \
            --verbose
          
          echo "âœ… API deployment complete!"

  # ============================================================================
  # Deploy UI to Static Web App
  # ============================================================================
  deploy-ui:
    name: Deploy UI
    runs-on: ubuntu-latest
    needs: [build-ui]
    environment:
      name: production
      url: https://ashy-glacier-0400c0b0f.1.azurestaticapps.net
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download UI artifact
        uses: actions/download-artifact@v4
        with:
          name: ui-package
          path: ./ui-package

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Get SWA Deployment Token
        id: swa-token
        run: |
          SWA_NAME="SWA-AMA-${{ inputs.deployment_number }}"
          RESOURCE_GROUP="AMAFY26-deployment-${{ inputs.deployment_number }}"
          
          echo "ðŸ”‘ Retrieving deployment token for $SWA_NAME..."
          
          DEPLOYMENT_TOKEN=$(az staticwebapp secrets list \
            --name "$SWA_NAME" \
            --resource-group "$RESOURCE_GROUP" \
            --query "properties.apiKey" \
            --output tsv)
          
          echo "::add-mask::$DEPLOYMENT_TOKEN"
          echo "token=$DEPLOYMENT_TOKEN" >> $GITHUB_OUTPUT

      - name: Deploy to Static Web App
        uses: Azure/static-web-apps-deploy@v1
        with:
          azure_static_web_apps_api_token: ${{ steps.swa-token.outputs.token }}
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          action: 'upload'
          app_location: './ui-package'
          skip_app_build: true
          skip_api_build: true

  # ============================================================================
  # Deployment Summary
  # ============================================================================
  deployment-summary:
    name: Deployment Summary
    runs-on: ubuntu-latest
    needs: [deploy-api, deploy-ui]
    if: always()
    steps:
      - name: Generate Summary
        run: |
          echo "## Application Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Deployment Number:** ${{ inputs.deployment_number }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Status | URL |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| API | ${{ needs.deploy-api.result == 'success' && 'âœ… Deployed' || 'âŒ Failed' }} | https://funcapp-ama-${{ inputs.deployment_number }}.azurewebsites.net |" >> $GITHUB_STEP_SUMMARY
          echo "| UI | ${{ needs.deploy-ui.result == 'success' && 'âœ… Deployed' || 'âŒ Failed' }} | https://swa-ama-${{ inputs.deployment_number }}.azurestaticapps.net |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Resource Group:** AMAFY26-deployment-${{ inputs.deployment_number }}" >> $GITHUB_STEP_SUMMARY
